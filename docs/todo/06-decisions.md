# Destiny.OS - 결정 사항 기록

## 개요

프로젝트 진행 중 결정된 사항들을 기록합니다.

---

## 2026-01-01: 초기 결정 사항

### 1. 프레임워크 선택

| 항목 | 결정 |
|------|------|
| 프레임워크 | Flutter (BLoC 패턴) |
| 아키텍처 | Clean Architecture |
| 상태관리 | flutter_bloc |

**이유**:
- 기획서에 Flutter + BLoC + Clean Architecture 명시
- 크로스 플랫폼 개발 효율성
- 토스 미니앱 연동 가능성 (확인 필요)

---

### 2. 배포 타겟

| 항목 | 결정 |
|------|------|
| 1차 타겟 | 독립 앱 (iOS/Android) |
| 2차 타겟 | 토스 미니앱 (가능 시) |

**주의사항**:
- ⚠️ 토스 미니앱에서 Flutter 런타임 가능 여부 **먼저 확인 필요**
- 불가능 시 미니앱은 웹(React) 기반으로 전환 검토
- 독립 앱 우선 개발 후 미니앱 포팅

---

### 3. 백엔드 구성

| 항목 | 결정 |
|------|------|
| 방식 | Serverless |
| 플랫폼 | ✅ **Supabase** (확정) |

**선택 근거**:
- 사주 데이터는 관계형 구조 (사주차트 → 십성 → MBTI 매핑)
- SQL 복잡 쿼리 필요 (대운 계산, 궁합 분석, JOIN)
- 비용 예측 가능 (storage 기반 과금, Firebase는 read/write 기반으로 변동폭 큼)
- 오픈소스, self-host 가능, 벤더 종속 없음
- Row Level Security(RLS)로 생년월일시 보안 강화

**구성**:
- Auth: Supabase Auth (Google, Apple, Kakao, 익명)
- Database: PostgreSQL (사용자/사주/상담 데이터)
- Edge Functions: AI 상담 API 프록시 (Deno, API 키 보호)

---

### 4. MVP 범위

| 항목 | 결정 |
|------|------|
| 범위 | Full 기능 |
| 특이사항 | AI 상담 1회 무료 제공 |

**포함 기능**:
1. 사주팔자 계산 및 분석
2. MBTI 연동 (Gap Analysis)
3. 2026년 운세 (월별 차트)
4. 대운 타임라인
5. 궁합 분석
6. AI 상담 (1회 무료)
7. 공유 기능

---

## ⚠️ 반드시 먼저 확정해야 하는 4가지 (리스크 탑)

### 1. 토스 미니앱에서 Flutter 가능 여부 ✅ 확인 완료

| 항목 | 상태 |
|------|------|
| 결과 | ❌ **Flutter 미지원** |
| 확인일 | 2026-01-01 |
| 출처 | [앱인토스 개발자센터](https://developers-apps-in-toss.toss.im) |

**토스 미니앱 공식 지원 기술 스택**:
| 기술 | 용도 | 비고 |
|------|------|------|
| **WebView** | 웹 기반 서비스 | HTML/CSS/JS |
| **React Native** | 네이티브 앱 | Granite 프레임워크 필수 |
| **Unity** | 게임 | 플러그인 제공 |
| **Cocos** | 게임 | 예제 제공 |

**React Native 개발 시 필수 사항**:
- [Granite 프레임워크](https://github.com/toss/granite) 사용 필수
- 기존 RN 앱도 Granite 기반 재스캐폴딩 필요
- [TDS (Toss Design System)](https://toss.im/design) 필수 적용 (검수 기준)
- 샌드박스 앱 테스트 필수

**대안 전략**:
| 옵션 | 장점 | 단점 |
|------|------|------|
| A. 독립 앱 Only | Flutter 유지 가능 | 토스 3000만 유저 접근 불가 |
| B. 독립 앱 + 웹앱 | Flutter + 웹뷰 미니앱 | 웹 별도 개발 필요 |
| C. React Native 전환 | 토스 완전 통합 | 기획서 스택 변경, 재개발 |

**권장**: **옵션 A (독립 앱 Only)** 또는 **옵션 B** 선택
- Flutter로 독립 앱 우선 출시
- 성과 검증 후 토스 미니앱은 웹 또는 RN으로 별도 개발 검토

### 2. AI(OpenAI 등) 호출 위치

| 항목 | 결정 |
|------|------|
| 결정 | ✅ 서버리스 함수 경유 |
| 이유 | API 키 유출/남용 방지 |
| 구현 | Cloud Functions 또는 Edge Functions |

**금지**: 클라이언트에서 직접 OpenAI API 호출

### 3. 생년월일시 저장 정책

| 항목 | 결정 |
|------|------|
| 기본값 | ✅ 로컬 Secure Storage (암호화) |
| 서버 저장 | 선택적, 명시적 동의 필요 |
| 서버 저장 시 | 파생 데이터/요약만 저장 권장 |

### 4. 60갑자/만세력 계산 기준

| 항목 | 결정 |
|------|------|
| 방식 | ✅ 표준 60갑자 테이블 기반 |
| 주의 | 단순 공식 계산 시 오차 발생 |
| 검증 | 전문가 크로스체크 필수 |

---

## 기타 결정 사항

### D6. 야자시(夜子時) 처리 ✅ 확정

| 항목 | 결정 |
|------|------|
| 방식 | ✅ **토글 제공** (선택권 보장) |
| 기본값 | 야자시 적용 (정통 명리학 존중) |
| UI | 입력 화면에 토글 + 결과 페이지 각주 |

**상세 설명**:
- 23:00~24:00 출생자는 학파에 따라 일주가 달라짐
- 야자시파: 23:00~24:00는 다음 날 子시로 계산
- 조자시파: 00:00 기준으로 날짜 변경
- **영향**: 일주 변경 → 십성 전체 재계산 → MBTI 추론 변경 → 궁합 결과 변경

**UI 구현**:
```
☑ 야자시 적용 (권장)
  └ 23:00~24:00 출생 시 다음 날로 계산

※ 학파에 따라 결과가 다를 수 있습니다.
```

---

### D7. 생년월일시 저장 정책 ✅ 확정

| 항목 | 결정 |
|------|------|
| 로컬 저장 | ✅ flutter_secure_storage (AES256 암호화) |
| 서버 저장 | 파생 데이터만 (원본 저장 금지) |
| 동의 | 클라우드 동기화 시 명시적 체크박스 동의 |
| 삭제권 | 앱 내 즉시 삭제 버튼 제공 |

**데이터 분류**:
| 등급 | 데이터 | 저장 위치 |
|------|--------|----------|
| 🔴 원본 | 생년월일시, 출생지 | 로컬 only |
| 🟡 파생 | 일간, 십성 분포, 오행 균형 | 로컬 + 서버(동의 시) |
| 🟢 결과 | 운세 텍스트, AI 상담 | 서버 저장 가능 |

**MVP 범위**:
- 로컬 저장만 지원
- 클라우드 동기화는 2차 개발

**사용자 권리**:
- 조회권: 내 데이터 확인
- 삭제권: 즉시 삭제 가능
- 이동권: JSON 내보내기

### 12지신 표현

| 항목 | 결정 |
|------|------|
| 방식 | Tossface 이모지 사용 |
| 이유 | 친근하고 현대적인 이미지 |

### 컬러 시스템

| 항목 | 결정 |
|------|------|
| 기반 | 토스 디자인 시스템 |
| 오방색 | 파스텔 톤으로 재해석 |

---

### 분석 옵션 체크박스 ✅ 확정

| 항목 | 결정 |
|------|------|
| 방식 | 체크박스로 분석 범위 선택 |
| 옵션 | 사주 / MBTI / 둘 다(Gap 분석) |
| 기본값 | 둘 다 선택 (통합 분석 권장) |

**UI 구현**:
```
┌─────────────────────────────────────┐
│  분석 옵션 선택                      │
├─────────────────────────────────────┤
│  ☑ 사주 분석                        │
│    └ 생년월일시 기반 운명 분석       │
│                                     │
│  ☑ MBTI 분석                        │
│    └ 현재 성격 유형 분석             │
│                                     │
│  ☑ Gap 분석 (둘 다 선택 시 활성화)   │
│    └ 선천적 기질 vs 현재 성향 비교   │
└─────────────────────────────────────┘
```

**비즈니스 로직**:
- 사주만: 사주팔자 + 십성 + 대운 + 2026운세
- MBTI만: 성격 유형 + 강점/약점 + 궁합 힌트 (생년월일 입력 불필요)
- 통합(권장): 위 둘 + Gap 분석 + 숨겨진 잠재력 인사이트

---

### AI 상담 1회권 정책 ✅ 확정

| 항목 | 결정 |
|------|------|
| 기준 | 계정(user_id) 기준 1회 무료 |
| 시점 | 사주/MBTI 분석 완료 후 |
| UI | "추가 질의하기" 버튼 |
| 추가 상담 | 유료 결제 필요 |

**상담 흐름**:
```
[사용자]
  └─> 사주/MBTI 분석 완료
       └─> 결과 화면 하단 "AI에게 질문하기" 버튼
            └─> 1회 무료 상담 진행
                 └─> 추가 상담 시 결제 유도
```

**남용 방지**:
- 계정당 1회 제한 (ai_consultation_used 플래그)
- Rate limiting (IP당 분당 5회)
- 익명 로그인도 1회 제한 적용

---

## 미결정 사항 (추후 확정)

| 항목 | 상태 | 액션 |
|------|------|------|
| 토스 미니앱 SDK 버전 | ❓ | 토스 개발자 문서 확인 |
| AI 상담 토큰 제한 | ❓ | 비용 산정 후 결정 |
| 앱 이름 최종 확정 | ❓ | 상표권 확인 필요 |
| 런칭 타이밍 | ❓ | 신년 운세 수요 고려 |
| ~~Firebase vs Supabase~~ | ✅ | Supabase 확정 |

---

## 변경 이력

| 날짜 | 항목 | 변경 내용 | 담당자 |
|------|------|----------|--------|
| 2026-01-01 | 초기 결정 | 모든 기본 결정 사항 문서화 | - |
| 2026-01-01 | D3 백엔드 | Supabase 확정 (관계형 DB 필요, 비용 예측성) | - |
| 2026-01-01 | D6 야자시 | 토글 제공 확정 (야자시 기본 적용) | - |
| 2026-01-01 | D7 저장정책 | 로컬 저장 기본, 파생데이터만 서버 저장 확정 | - |
| 2026-01-01 | 분석옵션 | 사주/MBTI/Gap 체크박스 선택 확정 | - |
| 2026-01-01 | AI 1회권 | 계정 기준 1회 무료, 분석 후 추가 질의 형태 확정 | - |

---

## 참고 자료

- [기획서 원본](../../MBTI+사주%20앱%20기획%20및%20개발%20전략.pdf)
- [토스 디자인 시스템](https://toss.im/design)
- [Flutter BLoC 문서](https://bloclibrary.dev/)
- [Firebase 문서](https://firebase.google.com/docs)
- [Supabase 문서](https://supabase.com/docs)
