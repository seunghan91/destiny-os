# 토스페이먼츠 환경 가이드 (테스트 vs 라이브)

> **필독**: 토스페이먼츠 연동 전 반드시 숙지해야 할 테스트/라이브 환경의 차이점 및 주의사항

## 📋 목차

1. [환경 개요](#환경-개요)
2. [테스트 환경 vs 라이브 환경](#테스트-환경-vs-라이브-환경)
3. [API 키의 종류와 사용법](#api-키의-종류와-사용법)
4. [결제 수단별 테스트 제약사항](#결제-수단별-테스트-제약사항)
5. [테스트 환경 필수 주의사항](#테스트-환경-필수-주의사항)
6. [라이브 환경 전환 체크리스트](#라이브-환경-전환-체크리스트)
7. [에러 시뮬레이션](#에러-시뮬레이션)

---

## 환경 개요

토스페이먼츠는 **테스트 환경**과 **라이브 환경**을 명확히 분리하여 제공합니다.

### 핵심 원칙

```
테스트 환경: 실제 결제 정보 사용 → 가상 승인 → 금전 이동 없음
라이브 환경: 실제 결제 정보 사용 → 실제 승인 → 실제 금전 이동
```

⚠️ **중요**: 테스트 환경에서는 실제 카드 번호를 입력해도 금액이 차감되지 않습니다!

---

## 테스트 환경 vs 라이브 환경

### 비교표

| 항목 | 테스트 환경 | 라이브 환경 |
|------|-----------|------------|
| **목적** | 개발 및 QA 테스트 | 실제 고객 결제 처리 |
| **API 키** | `test_` 접두사 | `live_` 접두사 |
| **금전 이동** | ❌ 없음 (가상 승인) | ✅ 실제 승인 및 정산 |
| **거래 내역** | 개발자센터 (테스트 결제 내역) | 상점관리자 |
| **카드 번호** | 실제 카드 사용 가능 (차감 X) | 실제 카드만 사용 가능 |
| **API 제한** | 100건/분 | 상점별 차등 |
| **계약 필요** | ❌ 회원가입만 | ✅ 전자결제 계약 필수 |
| **정산 조회** | 조회 불가 (정산 없음) | 실제 정산 내역 조회 |

### 테스트 환경 작동 원리

**1. 결제 승인은 가상**

```
사용자가 카드 번호 5570-7512-3456-1234 입력
  ↓
토스페이먼츠 테스트 서버로 전송
  ↓
✅ 승인 성공 (가상)
  ↓
❌ 실제 금액 차감 없음!
```

**2. 테스트 결제 내역 관리**

- 개발자센터 → 테스트 결제 내역
- 날짜별, 결제 수단별 필터링
- 가상계좌: 직접 "입금처리" 버튼으로 시뮬레이션
- 취소 처리: API 호출 없이 바로 취소 가능

**3. API 요청 제한**

```bash
# 테스트 환경
각 API당 100건/분 제한

# 라이브 환경
상점 규모에 따라 차등 (조정 가능)
```

---

## API 키의 종류와 사용법

### 키의 구조

토스페이먼츠 API 키는 **2x2 매트릭스** 구조:

| | 테스트 | 라이브 |
|---|--------|--------|
| **클라이언트 키** | `test_ck_...` / `test_gck_...` | `live_ck_...` / `live_gck_...` |
| **시크릿 키** | `test_sk_...` / `test_gsk_...` | `live_sk_...` / `live_gsk_...` |

### 클라이언트 키 vs 시크릿 키

#### 클라이언트 키 (Client Key)

```javascript
// 용도: 브라우저에서 결제위젯 초기화
const clientKey = 'test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm';

// 위젯 SDK 초기화
loadTossPayments(clientKey);
```

- **노출 가능**: 프론트엔드 코드에 포함 가능
- **역할**: 가맹점 계약 정보 불러오기, 결제위젯 설정
- **식별자**: `ck` (일반), `gck` (결제위젯)

#### 시크릿 키 (Secret Key)

```bash
# 용도: 백엔드에서 API 호출 시 인증
Authorization: Basic dGVzdF9za19kZWZhdWx0...
```

- **절대 노출 금지**: GitHub, 클라이언트 코드 ❌
- **역할**: API 요청 인증, 결제 승인
- **식별자**: `sk` (일반), `gsk` (결제위젯)
- **저장**: 환경 변수 또는 보안 저장소에만

### 키 세트 매칭 규칙

**❌ 잘못된 사용 (오류 발생)**

```javascript
// A세트 클라이언트 키로 결제 요청
const clientKey_A = 'test_gck_AAA...';

// B세트 시크릿 키로 승인 시도 (❌ INVALID_API_KEY 오류)
const secretKey_B = 'test_gsk_BBB...';
```

**✅ 올바른 사용**

```javascript
// A세트 클라이언트 키
const clientKey_A = 'test_gck_AAA...';

// A세트 시크릿 키 (반드시 세트로 사용)
const secretKey_A = 'test_gsk_AAA...';
```

### 키 발급 단계

```
1. 회원가입
   └─> "개발 연동 체험 상점" 테스트 키 발급
        (test_ck, test_sk만)

2. 전자결제 계약 신청
   └─> 심사 중... (토스 1~2일 + 카드사 최대 14일)

3. 계약 완료
   └─> 상점아이디(MID) 발급
        └─> 테스트 키 + 라이브 키 모두 발급
             (test_ck, test_sk, live_ck, live_sk)
```

### 보안 키 (특수 용도)

```
보안 키: 16진수 64자 길이
용도: 지급대행 API의 Request Body JWE 암호화
필수 API:
  - 셀러 등록 API
  - 셀러 수정 API
  - 지급대행 요청 API
```

---

## 결제 수단별 테스트 제약사항

### 📌 중요: 테스트 환경에서 실제 결제는 일어나지 않습니다!

> 유효한 카드 번호로 테스트해도 실제로 결제가 되지 않으며, 결제수단에서 빠져나가는 금액은 없습니다.

### 1. 신용카드 / 체크카드

#### ✅ 테스트 가능
- 모든 카드사 테스트 가능
- 유효한 카드 번호 입력 → 가상 승인
- 실제 금액 차감 ❌

#### ⚠️ 주의사항
- 테스트 환경: 모바일 인증번호 없이 테스트 가능
- 라이브 환경: 실제 본인인증 필요

#### 📝 테스트 카드 정보
```
카드 번호: 5570-7512-3456-1234 (Mastercard)
유효 기간: 12/25 (미래 날짜)
CVC: 123
비밀번호: 00 (앞 2자리)
```

---

### 2. 간편결제

| 서비스 | 테스트 환경 | 라이브 환경 | 비고 |
|--------|-----------|------------|------|
| **토스페이** | ✅ 모든 테스트 키 | ✅ | 개발 연동 체험 상점 가능 |
| **네이버페이** | ✅ 모든 테스트 키 | ✅ | 개발 연동 체험 상점 가능 |
| **카카오페이** | ⚠️ 계약 후 MID 테스트 키 | ✅ | 계약 필수 |
| **애플페이** | ✅ MID 테스트 키 | ✅ | **iPhone, Mac Safari만 노출** |
| **삼성페이** | ✅ MID 테스트 키 | ✅ | 개발 연동 체험 상점 가능 |
| **SSG페이** | ✅ MID 테스트 키 | ✅ | 개발 연동 체험 상점 가능 |
| **엘페이** | ✅ MID 테스트 키 | ✅ | 개발 연동 체험 상점 가능 |
| **핀페이** | ✅ MID 테스트 키 | ✅ | 개발 연동 체험 상점 가능 |
| **페이코** | ❌ 테스트 불가 | ✅ 라이브 키로 테스트 | ⚠️ 실제 금전 이동 주의 |

#### ⚠️ 중요 주의사항

**카카오페이**
- 개발 연동 체험 상점에서는 사용 불가
- 토스페이먼츠와 계약 완료 후 MID 테스트 키로만 테스트 가능

**애플페이**
- **iPhone 및 Mac Safari 에서만 노출**
- 다른 환경에서는 결제 수단 목록에 표시되지 않음

**페이코**
- 테스트 키로 연동 불가능
- **라이브 키로 테스트 필요** → 실제 금액 차감 주의!

---

### 3. 가상계좌

#### ✅ 테스트 방법

```
1. 가상계좌 발급 요청
   ↓
2. 계좌번호 발급 (예: X1234567890)
   → 앞에 'X' 표시
   ↓
3. 개발자센터 → 테스트 결제 내역
   ↓
4. "입금처리" 버튼 클릭 (직접 입금 불가)
   ↓
5. 입금 완료 상태 시뮬레이션
```

#### ⚠️ 제약사항

| 항목 | 테스트 환경 | 라이브 환경 |
|------|-----------|------------|
| **계좌번호 형식** | `X1234567890` (X 접두사) | `1234567890` (정상) |
| **실제 입금** | ❌ 불가능 | ✅ 실제 계좌로 입금 |
| **입금 확인** | "입금처리" 버튼 클릭 | 실제 입금 시 자동 확인 |
| **안내 문자** | ❌ 발송 안 됨 (개발 연동 체험) | ✅ 발송 (MID 테스트 키) |

---

### 4. 자동결제 (빌링)

#### ✅ 테스트 방법

```
1. 카드 정보 등록
2. 빌링키 발급
3. 빌링키로 자동 결제 요청
```

#### ⚠️ 주의사항

| 항목 | 테스트 환경 | 라이브 환경 |
|------|-----------|------------|
| **카드 번호 검증** | BIN 번호(앞 6자리)만 유효하면 OK | 전체 카드 번호 유효해야 함 |
| **휴대폰 인증** | `000000` 입력 | 실제 인증번호 필요 |
| **KYC 심사** | `KYC_REQUIRED` 상태만 | `APPROVED` 상태 가능 |

**BIN 번호 차이 예시**:
```
테스트: 5570-XX-XXXX-XXXX (앞 6자리만 유효하면 OK)
라이브: 5570-75-1234-5678 (전체 번호 유효해야 함)
```

---

### 5. 계좌이체

#### ✅ 테스트 가능 항목
- 계좌번호: 가상 값 OK
- 비밀번호: 가상 값 OK
- 계좌 소유주: 가상 값 OK
- 보안카드: 가상 값 OK
- OTP: 가상 값 OK

#### ⚠️ 실제 필요 항목
- **공동 인증서**: 실제로 인증 필요 (모의 불가)

---

### 6. 게임 문화 상품권

```
테스트:
- 가상 PIN 번호 입력 가능
- 사용 가능 금액: 항상 10,000원 표시

라이브:
- 실제 PIN 번호 필요
- 실제 잔액 조회
```

---

### 7. 영수증

| 항목 | 테스트 환경 | 라이브 환경 |
|------|-----------|------------|
| **영수증 URL** | ✅ 생성됨 | ✅ 생성됨 |
| **실제 데이터** | ❌ 제공 안 됨 | ✅ 실제 영수증 |
| **샘플 확인** | 결제 결과 안내 가이드 참조 | - |

---

### 8. 정산

```
테스트 환경:
- 정산 조회 API 호출 → 정산 기록 없음 (Empty)

라이브 환경:
- 정산 조회 API 호출 → 실제 정산 내역 반환
```

---

### 9. 지급대행

| 항목 | 테스트 환경 | 라이브 환경 |
|------|-----------|------------|
| **잔액 조회** | `availableAmount`만 반환 | 전체 정보 반환 |
| **셀러 등록** | 유효한 사업자번호 필요 | 유효한 사업자번호 필요 |
| **셀러 타입** | 법인사업자(CORPORATE)만 | 모든 타입 |
| **KYC 심사** | `KYC_REQUIRED` 상태만 | `APPROVED` 가능 |
| **수수료** | ❌ 부과 안 됨 | ⚠️ **실제 수수료 부과!** |

⚠️ **매우 중요**: 지급대행 요청 API를 라이브 환경에서 테스트하면 **실제 수수료가 부과**됩니다!

---

## 테스트 환경 필수 주의사항

### 1. 브라우저 지원

#### 데스크톱

| 브라우저 | 최소 버전 |
|---------|----------|
| Chrome | 72 이상 |
| Edge | 79 이상 |
| Firefox | 64 이상 |
| Safari | 13 이상 |
| Whale | 1.6.81.8 이상 |

#### 모바일

| 환경 | 지원 브라우저 |
|------|-------------|
| iOS | Safari |
| Android | Chrome, 삼성 인터넷 |

⚠️ **최신 버전 사용 권장**: 오류 최소화

---

### 2. 보안 프로토콜

#### HTTPS 필수

```
❌ HTTP: 개인정보 유출 위험
✅ HTTPS: 암호화 통신 (필수)
```

#### TLS 버전

```
❌ TLS 1.0, 1.1: 보안 취약
✅ TLS 1.2 이상: 필수
```

#### 지원 Cipher Suite

```
✅ TLS_AES_128_GCM_SHA256
✅ TLS_AES_256_GCM_SHA384
✅ TLS_CHACHA20_POLY1305_SHA256
✅ ECDHE-ECDSA-AES128-GCM-SHA256
✅ ECDHE-RSA-AES128-GCM-SHA256
... (보안이 강한 알고리즘만 지원)
```

---

### 3. 방화벽 설정

#### 아웃바운드 (상점 → 토스페이먼츠)

```bash
# HTTPS 443 포트 허용
포트: 443
프로토콜: HTTPS

# API 엔드포인트 IP 허용
103.182.251.2
103.182.250.2
```

#### 인바운드 (토스페이먼츠 → 상점 웹훅)

```bash
# 웹훅 URL 포트 허용
# IP 화이트리스트 추가

[INBOUND 허용 IP]
13.124.18.147
13.124.108.35
3.36.173.151
3.38.81.32
115.92.221.121
115.92.221.122
115.92.221.123
115.92.221.125
115.92.221.126
115.92.221.127
```

---

### 4. API 요청 제한

```
테스트 환경: 각 API당 100건/분

초과 시: HTTP 429 Too Many Requests
```

**대응 방법**:
- 요청 간격 조절
- Exponential Backoff 구현
- 병렬 요청 제한

---

### 5. 결제 승인 시간 제한

```
결제 요청 → 인증 완료 → [10분 이내] → 결제 승인 API 호출

10분 초과 시:
- 결제 데이터 유실
- 결제 상태: '만료'
- 승인 불가
```

⚠️ **중요**: 결제 흐름 설계 시 10분 제한 고려 필수

---

## 라이브 환경 전환 체크리스트

### 사전 계약

- [ ] 토스페이먼츠 전자결제 계약 신청
- [ ] 토스페이먼츠 심사 완료 (1~2일)
- [ ] 카드사 심사 완료 (최대 14일)
- [ ] 상점아이디(MID) 발급 확인
- [ ] 상점관리자 접속 확인

---

### API 키 검증

- [ ] 라이브 클라이언트 키 확인 (`live_ck_` / `live_gck_`)
- [ ] 라이브 시크릿 키 확인 (`live_sk_` / `live_gsk_`)
- [ ] 클라이언트 키 ↔ 시크릿 키 매칭 확인
- [ ] 테스트 키와 라이브 키 분리 확인
- [ ] 시크릿 키 환경 변수 저장 확인
- [ ] `.gitignore`에 `.env` 추가 확인

**환경 변수 예시**:
```bash
# .env (라이브 환경)
TOSS_CLIENT_KEY=live_gck_YOUR_CLIENT_KEY
TOSS_SECRET_KEY=live_gsk_YOUR_SECRET_KEY
NODE_ENV=production
```

---

### 보안 설정

- [ ] 시크릿 키 외부 노출 차단
- [ ] GitHub 등 버전 관리에 키 미포함
- [ ] HTTPS 적용 확인
- [ ] TLS 1.2 이상 지원 확인
- [ ] Cipher Suite 지원 확인
- [ ] 방화벽 IP 화이트리스트 설정
- [ ] 웹훅 URL 포트 허용

---

### 결제 수단 계약 확인

- [ ] 사용할 모든 결제 수단 계약 완료
- [ ] 자동결제(빌링) 계약 (필요 시)
- [ ] 복합결제 계약 (필요 시)
- [ ] 간편결제 개별 계약 (카카오페이 등)

⚠️ **미계약 시**: `NOT_SUPPORTED_METHOD` 오류 발생

---

### 웹훅 설정

- [ ] 웹훅 엔드포인트 구현 완료
- [ ] 200 OK 응답 반환 확인
- [ ] 멱등성 처리 구현
- [ ] 웹훅 서명 검증 로직 추가
- [ ] 재시도 처리 로직 구현

---

### 모니터링 & 알림

- [ ] 로깅 시스템 구축
- [ ] API 응답 시간 모니터링
- [ ] 결제 성공률 추적
- [ ] 카드 거부율 추적
- [ ] 결제 취소율 추적
- [ ] 에러 로깅 및 알림 설정
- [ ] 웹훅 실패 알림 설정

---

### 롤백 계획

- [ ] 이전 버전 롤백 절차 문서화
- [ ] 롤백 테스트 완료
- [ ] 데이터베이스 백업 설정
- [ ] 재해 복구 계획 수립

---

### 최종 검증

- [ ] 테스트 환경에서 모든 시나리오 검증
- [ ] 라이브 환경에서 소액 테스트 (1,000원)
- [ ] 결제 승인 정상 동작 확인
- [ ] 영수증 발급 확인
- [ ] 정산 프로세스 확인
- [ ] 웹훅 수신 확인

---

## 에러 시뮬레이션

### TossPayments-Test-Code 헤더 사용

테스트 환경에서 특정 에러를 재현할 수 있습니다.

#### 사용 방법

```bash
# API 요청 헤더에 추가
curl -X POST https://api.tosspayments.com/v1/payments/confirm \
  -H "Authorization: Basic $(echo -n 'test_sk_YOUR_KEY:' | base64)" \
  -H "TossPayments-Test-Code: REJECT_CARD_PAYMENT" \
  -H "Content-Type: application/json" \
  -d '{
    "paymentKey": "test_payment_key",
    "orderId": "test_order_id",
    "amount": 10000
  }'
```

⚠️ **필수**: 반드시 테스트 시크릿 키 사용 (라이브 키는 무시됨)

#### 주요 에러 코드

| 에러 코드 | 설명 | 시뮬레이션 시나리오 |
|----------|------|-------------------|
| `REJECT_CARD_PAYMENT` | 카드 결제 거부 | 잔액 부족, 한도 초과 |
| `INVALID_CARD_EXPIRATION` | 유효기간 오류 | 만료된 카드 |
| `INVALID_CARD_INSTALLMENT_PLAN` | 할부 개월 오류 | 지원하지 않는 할부 |
| `NOT_FOUND_TERMINAL_ID` | 단말기 ID 없음 | 미등록 단말기 |
| `INVALID_API_KEY` | API 키 오류 | 잘못된 키 사용 |

#### 테스트 예시

**시나리오 1: 잔액 부족**

```javascript
const response = await fetch('https://api.tosspayments.com/v1/payments/confirm', {
  method: 'POST',
  headers: {
    'Authorization': `Basic ${Buffer.from('test_sk_YOUR_KEY:').toString('base64')}`,
    'TossPayments-Test-Code': 'REJECT_CARD_PAYMENT',
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    paymentKey: 'test_payment_key',
    orderId: 'order_001',
    amount: 100000,
  }),
});

// 응답: { code: 'REJECT_CARD_PAYMENT', message: '잔액 부족' }
```

**시나리오 2: 유효기간 만료**

```javascript
headers: {
  'TossPayments-Test-Code': 'INVALID_CARD_EXPIRATION'
}

// 응답: { code: 'INVALID_CARD_EXPIRATION', message: '유효기간이 만료되었습니다' }
```

---

## 샌드박스 (코드 없이 테스트)

### 접근 방법

1. 토스페이먼츠 개발자센터 로그인
2. **샌드박스** 메뉴 클릭
3. 결제 수단 선택
4. 결제 정보 입력
5. 결제 요청 → 인증 완료
6. `paymentKey`, `orderId` 확인
7. 제공된 API 호출 코드로 승인 테스트

### 장점

- 코드 작성 불필요
- 즉시 결제 흐름 체험
- API 호출 예시 제공
- 실제 `paymentKey` 발급

---

## 참고 자료

### 공식 문서

- [토스페이먼츠 환경 설정](https://docs.tosspayments.com/guides/v2/get-started/environment)
- [API 키 관리](https://docs.tosspayments.com/reference/using-api/api-keys)
- [보안 가이드](https://docs.tosspayments.com/reference/using-api/security)
- [웹훅 가이드](https://docs.tosspayments.com/guides/v2/webhook)
- [에러 코드](https://docs.tosspayments.com/reference/error-codes)

### 고객센터

- 📞 전화: 1544-7772
- 📧 이메일: support@tosspayments.com

---

**작성일**: 2026-01-01
**버전**: 1.0.0
**기반 문서**: https://docs.tosspayments.com/guides/environment
