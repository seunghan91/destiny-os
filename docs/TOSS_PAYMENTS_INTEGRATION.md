# í† ìŠ¤í˜ì´ë¨¼ì¸  ì—°ë™ ì„¤ê³„ ë¬¸ì„œ

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì•„í‚¤í…ì²˜ ì„¤ê³„](#ì•„í‚¤í…ì²˜-ì„¤ê³„)
3. [ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ](#ë°ì´í„°ë² ì´ìŠ¤-ìŠ¤í‚¤ë§ˆ)
4. [ê²°ì œ íë¦„](#ê²°ì œ-íë¦„)
5. [êµ¬ë… ê²°ì œ ì‹œìŠ¤í…œ](#êµ¬ë…-ê²°ì œ-ì‹œìŠ¤í…œ)
6. [ë³´ì•ˆ ì„¤ê³„](#ë³´ì•ˆ-ì„¤ê³„)
7. [êµ¬í˜„ ê°€ì´ë“œ](#êµ¬í˜„-ê°€ì´ë“œ)
8. [í…ŒìŠ¤íŠ¸ ê³„íš](#í…ŒìŠ¤íŠ¸-ê³„íš)

---

## ê°œìš”

### í”„ë¡œì íŠ¸ ì •ë³´
- **ì„œë¹„ìŠ¤ëª…**: Destiny.OS (MBTI ìš´ì„¸ ì•±)
- **ê²°ì œ ë°©ì‹**:
  - ë‹¨ê±´ ê²°ì œ (ìƒì„¸ ìš´ì„¸ ë¶„ì„: 3,000ì› ~ 5,000ì›)
  - ì •ê¸° êµ¬ë… (í”„ë¦¬ë¯¸ì—„: ì›” 9,900ì›)
- **ê²°ì œ ì œê³µì**: í† ìŠ¤í˜ì´ë¨¼ì¸  (Toss Payments)
- **ë°±ì—”ë“œ**: Supabase (PostgreSQL + Edge Functions)
- **í”„ë¡ íŠ¸ì—”ë“œ**: Flutter 3.10+

### ì£¼ìš” ê¸°ëŠ¥
- ğŸ”® AI ìƒë‹´ ì¶”ê°€ ê²°ì œ (1íšŒ ë¬´ë£Œ í›„ ìœ ë£Œ)
- ğŸ“Š ìƒì„¸ ìš´ì„¸ ë¶„ì„ ë¦¬í¬íŠ¸ êµ¬ë§¤
- ğŸ’³ í”„ë¦¬ë¯¸ì—„ êµ¬ë… (ì›”ê°„ ìë™ê²°ì œ)
- ğŸ’• ê¶í•© ë¶„ì„ ì¶”ê°€ êµ¬ë§¤

---

## ì•„í‚¤í…ì²˜ ì„¤ê³„

### ì‹œìŠ¤í…œ êµ¬ì„±ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Flutter App                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Payment UI   â”‚  â”‚ Subscription â”‚  â”‚ Purchase     â”‚  â”‚
â”‚  â”‚ (Widget SDK) â”‚  â”‚ Management   â”‚  â”‚ History      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ Supabase Edge  â”‚
                   â”‚   Functions    â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Toss Paymentsâ”‚   â”‚  PostgreSQL  â”‚
        â”‚     API      â”‚   â”‚   Database   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ë ˆì´ì–´ êµ¬ì¡° (Clean Architecture)

```
lib/
â”œâ”€â”€ features/
â”‚   â””â”€â”€ payment/
â”‚       â”œâ”€â”€ presentation/
â”‚       â”‚   â”œâ”€â”€ pages/
â”‚       â”‚   â”‚   â”œâ”€â”€ payment_page.dart
â”‚       â”‚   â”‚   â”œâ”€â”€ subscription_page.dart
â”‚       â”‚   â”‚   â””â”€â”€ purchase_history_page.dart
â”‚       â”‚   â”œâ”€â”€ widgets/
â”‚       â”‚   â”‚   â”œâ”€â”€ toss_payment_widget.dart
â”‚       â”‚   â”‚   â”œâ”€â”€ payment_method_selector.dart
â”‚       â”‚   â”‚   â””â”€â”€ subscription_card.dart
â”‚       â”‚   â””â”€â”€ bloc/
â”‚       â”‚       â”œâ”€â”€ payment_bloc.dart
â”‚       â”‚       â”œâ”€â”€ payment_event.dart
â”‚       â”‚       â””â”€â”€ payment_state.dart
â”‚       â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ entities/
â”‚       â”‚   â”‚   â”œâ”€â”€ payment.dart
â”‚       â”‚   â”‚   â”œâ”€â”€ subscription.dart
â”‚       â”‚   â”‚   â””â”€â”€ product.dart
â”‚       â”‚   â”œâ”€â”€ repositories/
â”‚       â”‚   â”‚   â””â”€â”€ payment_repository.dart
â”‚       â”‚   â””â”€â”€ usecases/
â”‚       â”‚       â”œâ”€â”€ process_payment.dart
â”‚       â”‚       â”œâ”€â”€ create_subscription.dart
â”‚       â”‚       â”œâ”€â”€ cancel_subscription.dart
â”‚       â”‚       â””â”€â”€ get_payment_history.dart
â”‚       â””â”€â”€ data/
â”‚           â”œâ”€â”€ models/
â”‚           â”‚   â”œâ”€â”€ payment_model.dart
â”‚           â”‚   â”œâ”€â”€ subscription_model.dart
â”‚           â”‚   â””â”€â”€ toss_payment_response.dart
â”‚           â”œâ”€â”€ datasources/
â”‚           â”‚   â”œâ”€â”€ toss_payment_remote_datasource.dart
â”‚           â”‚   â””â”€â”€ payment_local_datasource.dart
â”‚           â””â”€â”€ repositories/
â”‚               â””â”€â”€ payment_repository_impl.dart
```

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### Supabase PostgreSQL í…Œì´ë¸” ì„¤ê³„

```sql
-- 1. ì‚¬ìš©ì í…Œì´ë¸” (í™•ì¥)
ALTER TABLE users
ADD COLUMN subscription_tier VARCHAR(20) DEFAULT 'free',
ADD COLUMN subscription_status VARCHAR(20) DEFAULT 'inactive',
ADD COLUMN billing_key TEXT,
ADD COLUMN subscription_started_at TIMESTAMP,
ADD COLUMN subscription_expires_at TIMESTAMP;

-- 2. ìƒí’ˆ í…Œì´ë¸”
CREATE TABLE products (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(100) NOT NULL,
  description TEXT,
  product_type VARCHAR(20) NOT NULL, -- 'single', 'subscription'
  price INTEGER NOT NULL, -- ì›í™” ê¸ˆì•¡ (KRW)
  currency VARCHAR(3) DEFAULT 'KRW',
  features JSONB, -- ìƒí’ˆ íŠ¹ì§• (JSON ë°°ì—´)
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 3. ê²°ì œ ë‚´ì—­ í…Œì´ë¸”
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id),

  -- í† ìŠ¤í˜ì´ë¨¼ì¸  ì •ë³´
  payment_key VARCHAR(200) UNIQUE NOT NULL,
  order_id VARCHAR(100) UNIQUE NOT NULL,
  order_name VARCHAR(100) NOT NULL,

  -- ê²°ì œ ì •ë³´
  amount INTEGER NOT NULL,
  currency VARCHAR(3) DEFAULT 'KRW',
  payment_method VARCHAR(50), -- 'CARD', 'VIRTUAL_ACCOUNT', etc.
  payment_status VARCHAR(20) NOT NULL, -- 'PENDING', 'DONE', 'CANCELED', 'FAILED'

  -- íƒ€ì„ìŠ¤íƒ¬í”„
  requested_at TIMESTAMP DEFAULT NOW(),
  approved_at TIMESTAMP,
  canceled_at TIMESTAMP,

  -- ì¶”ê°€ ì •ë³´
  failure_code VARCHAR(50),
  failure_message TEXT,
  receipt_url TEXT,
  metadata JSONB, -- ì¶”ê°€ ì •ë³´ (flexible)

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 4. êµ¬ë… ë‚´ì—­ í…Œì´ë¸”
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  product_id UUID REFERENCES products(id),

  -- ë¹Œë§í‚¤ ì •ë³´
  billing_key TEXT NOT NULL,
  customer_key VARCHAR(100) NOT NULL,

  -- êµ¬ë… ìƒíƒœ
  status VARCHAR(20) NOT NULL, -- 'ACTIVE', 'PAUSED', 'CANCELED', 'EXPIRED'
  tier VARCHAR(20) NOT NULL, -- 'premium', 'pro'

  -- êµ¬ë… ê¸°ê°„
  started_at TIMESTAMP NOT NULL,
  current_period_start TIMESTAMP NOT NULL,
  current_period_end TIMESTAMP NOT NULL,
  canceled_at TIMESTAMP,

  -- ê²°ì œ ì •ë³´
  billing_cycle VARCHAR(20) DEFAULT 'monthly', -- 'monthly', 'yearly'
  next_billing_date TIMESTAMP,
  amount INTEGER NOT NULL,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 5. êµ¬ë… ê²°ì œ ë‚´ì—­ í…Œì´ë¸”
CREATE TABLE subscription_payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  subscription_id UUID REFERENCES subscriptions(id) ON DELETE CASCADE,
  payment_id UUID REFERENCES payments(id),

  billing_date TIMESTAMP NOT NULL,
  amount INTEGER NOT NULL,
  status VARCHAR(20) NOT NULL, -- 'SUCCESS', 'FAILED', 'PENDING'

  created_at TIMESTAMP DEFAULT NOW()
);

-- 6. ì›¹í›… ì´ë²¤íŠ¸ ë¡œê·¸ í…Œì´ë¸”
CREATE TABLE webhook_events (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  event_type VARCHAR(50) NOT NULL,
  payment_key VARCHAR(200),

  payload JSONB NOT NULL,
  processed BOOLEAN DEFAULT false,
  processed_at TIMESTAMP,

  created_at TIMESTAMP DEFAULT NOW()
);

-- ì¸ë±ìŠ¤ ìƒì„±
CREATE INDEX idx_payments_user_id ON payments(user_id);
CREATE INDEX idx_payments_status ON payments(payment_status);
CREATE INDEX idx_payments_payment_key ON payments(payment_key);
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
CREATE INDEX idx_subscriptions_next_billing ON subscriptions(next_billing_date);

-- Row Level Security (RLS) ì„¤ì •
ALTER TABLE payments ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscriptions ENABLE ROW LEVEL SECURITY;
ALTER TABLE subscription_payments ENABLE ROW LEVEL SECURITY;

-- RLS ì •ì±…: ì‚¬ìš©ìëŠ” ìì‹ ì˜ ê²°ì œ ì •ë³´ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Users can view own payments"
  ON payments FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can view own subscriptions"
  ON subscriptions FOR SELECT
  USING (auth.uid() = user_id);
```

### ì´ˆê¸° ìƒí’ˆ ë°ì´í„°

```sql
-- ìƒí’ˆ ë“±ë¡ (ì˜ˆì‹œ)
INSERT INTO products (name, description, product_type, price, features) VALUES
('AI ìƒë‹´ 1íšŒ', 'ì‚¬ì£¼/MBTI ê¸°ë°˜ AI ë§ì¶¤ ìƒë‹´', 'single', 3000,
 '["GPT-4o ê¸°ë°˜ ìƒë‹´", "ê°œì¸í™”ëœ ì¡°ì–¸", "24ì‹œê°„ ì´ë‚´ ë‹µë³€"]'::jsonb),

('ìƒì„¸ ìš´ì„¸ ë¶„ì„', '2026ë…„ ìƒì„¸ ì›”ë³„ ìš´ì„¸ ë¦¬í¬íŠ¸', 'single', 5000,
 '["12ê°œì›” ìƒì„¸ ë¶„ì„", "ëŒ€ìš´ íƒ€ì„ë¼ì¸", "PDF ë‹¤ìš´ë¡œë“œ"]'::jsonb),

('í”„ë¦¬ë¯¸ì—„ êµ¬ë…', 'ëª¨ë“  ê¸°ëŠ¥ ë¬´ì œí•œ ì´ìš©', 'subscription', 9900,
 '["ë¬´ì œí•œ AI ìƒë‹´", "ì›”ë³„ ìš´ì„¸ ìë™ ì—…ë°ì´íŠ¸", "ê´‘ê³  ì œê±°", "ìš°ì„  ì§€ì›"]'::jsonb);
```

---

## ê²°ì œ íë¦„

### 1. ì¼ë°˜ ê²°ì œ (Single Payment) íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ì‚¬ìš©ì    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 1. ìƒí’ˆ ì„ íƒ (AI ìƒë‹´, ìƒì„¸ ë¶„ì„ ë“±)
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter App â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 2. ê²°ì œ ìš”ì²­ (ì£¼ë¬¸ ìƒì„±)
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function:   â”‚
â”‚ create-payment   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 3. ì£¼ë¬¸ ì •ë³´ ì €ì¥ (DB)
      â”‚    - orderId, amount ì„ì‹œ ì €ì¥
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 4. clientKey, orderId ë°˜í™˜
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter App â”‚
â”‚ (í† ìŠ¤ ìœ„ì ¯) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 5. ê²°ì œìœ„ì ¯ ë Œë”ë§
      â”‚    - ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ
      â”‚    - ì•½ê´€ ë™ì˜
      â”‚    - requestPayment() í˜¸ì¶œ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Toss Paymentsâ”‚
â”‚   (ì¸ì¦)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 6. ì¹´ë“œì‚¬ AppCard ë³¸ì¸ì¸ì¦
      â”‚
      â”‚ 7. ì„±ê³µ ì‹œ successUrlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
      â”‚    (paymentKey, orderId, amount í¬í•¨)
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function:   â”‚
â”‚ confirm-payment  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 8. ê¸ˆì•¡ ê²€ì¦
      â”‚    - DBì˜ ì´ˆê¸° ê¸ˆì•¡ vs ë°˜í™˜ëœ ê¸ˆì•¡ ë¹„êµ
      â”‚
      â”‚ 9. í† ìŠ¤ ê²°ì œ ìŠ¹ì¸ API í˜¸ì¶œ
      â”‚    POST /payments/confirm
      â”‚    Body: { paymentKey, orderId, amount }
      â”‚    Header: Authorization: Basic {ì‹œí¬ë¦¿í‚¤}
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Toss Paymentsâ”‚
â”‚   (ìŠ¹ì¸)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 10. ìŠ¹ì¸ ì™„ë£Œ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 11. ê²°ì œ ì •ë³´ DB ì €ì¥
      â”‚     - status: 'DONE'
      â”‚     - approved_at ê¸°ë¡
      â”‚     - receipt_url ì €ì¥
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 12. ì„±ê³µ ì‘ë‹µ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Flutter App â”‚
â”‚ (ì™„ë£Œ í™”ë©´) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. êµ¬ë… ê²°ì œ (Subscription) íë¦„

```
[ì´ˆíšŒ ê²°ì œ - ë¹Œë§í‚¤ ë°œê¸‰]

ì‚¬ìš©ì â†’ Flutter App â†’ Edge Function â†’ Toss Payments
                            â†“
                      (ë¹Œë§í‚¤ ë°œê¸‰)
                            â†“
                   PostgreSQL ì €ì¥
                   (subscriptions í…Œì´ë¸”)

[ì •ê¸° ê²°ì œ - ìë™ ì²­êµ¬]

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cron Job        â”‚
â”‚  (ë§¤ì¼ ìì • ì‹¤í–‰) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚ 1. next_billing_dateê°€ ì˜¤ëŠ˜ì¸ êµ¬ë… ì¡°íšŒ
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function:   â”‚
â”‚ process-billing  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 2. ê° êµ¬ë…ë§ˆë‹¤ ë°˜ë³µ
      â”‚    - billing_key ì¡°íšŒ
      â”‚    - ìë™ ê²°ì œ ìš”ì²­
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Toss Paymentsâ”‚
â”‚ (ë¹Œë§ API)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 3. ê²°ì œ ì²˜ë¦¬
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Edge Function    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚ 4. ê²°ì œ ì„±ê³µ ì‹œ
      â”‚    - payments í…Œì´ë¸” ì €ì¥
      â”‚    - subscription_payments ê¸°ë¡
      â”‚    - next_billing_date ê°±ì‹  (+1ê°œì›”)
      â”‚    - current_period_end ê°±ì‹ 
      â”‚
      â”‚ 5. ê²°ì œ ì‹¤íŒ¨ ì‹œ
      â”‚    - ì¬ì‹œë„ ë¡œì§ (3íšŒ)
      â”‚    - ì‹¤íŒ¨ ì‹œ ì´ë©”ì¼ ì•Œë¦¼
      â”‚    - status: 'PAUSED'
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## êµ¬ë… ê²°ì œ ì‹œìŠ¤í…œ

### êµ¬ë… ìƒíƒœ ê´€ë¦¬

```dart
enum SubscriptionStatus {
  active,    // ì •ìƒ í™œì„±
  paused,    // ì¼ì‹œ ì¤‘ì§€ (ê²°ì œ ì‹¤íŒ¨ ë“±)
  canceled,  // ì‚¬ìš©ìê°€ ì·¨ì†Œ
  expired,   // ë§Œë£Œë¨
}

enum SubscriptionTier {
  free,      // ë¬´ë£Œ
  premium,   // í”„ë¦¬ë¯¸ì—„ (ì›” 9,900ì›)
}
```

### ë¹Œë§í‚¤ ë°œê¸‰ (Initial Subscription)

```dart
// presentation/bloc/payment_bloc.dart

Future<void> _onSubscribeRequested(
  SubscribeRequested event,
  Emitter<PaymentState> emit,
) async {
  emit(PaymentLoading());

  try {
    // 1. ê³ ê° í‚¤ ìƒì„±
    final customerKey = 'customer_${userId}_${DateTime.now().millisecondsSinceEpoch}';

    // 2. ê²°ì œìœ„ì ¯ ì´ˆê¸°í™” ë° ê²°ì œ ìš”ì²­
    final paymentResult = await _processPaymentUseCase(
      PaymentParams(
        amount: event.subscriptionPrice,
        orderName: '${event.tier} êµ¬ë…',
        customerKey: customerKey,
      ),
    );

    // 3. ë¹Œë§í‚¤ ë°œê¸‰ ìš”ì²­ (Edge Function)
    final subscription = await _createSubscriptionUseCase(
      SubscriptionParams(
        paymentKey: paymentResult.paymentKey,
        customerKey: customerKey,
        tier: event.tier,
      ),
    );

    emit(SubscriptionSuccess(subscription));
  } catch (e) {
    emit(PaymentFailure(e.toString()));
  }
}
```

### Edge Function: ë¹Œë§í‚¤ ë°œê¸‰ ë° ì €ì¥

```typescript
// supabase/functions/create-subscription/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  try {
    const { paymentKey, customerKey, tier } = await req.json();

    // 1. í† ìŠ¤í˜ì´ë¨¼ì¸  ë¹Œë§í‚¤ ë°œê¸‰ API í˜¸ì¶œ
    const tossResponse = await fetch(
      `https://api.tosspayments.com/v1/billing/authorizations/${paymentKey}`,
      {
        method: 'POST',
        headers: {
          'Authorization': `Basic ${btoa(Deno.env.get('TOSS_SECRET_KEY') + ':')}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          customerKey,
        }),
      }
    );

    if (!tossResponse.ok) {
      throw new Error('ë¹Œë§í‚¤ ë°œê¸‰ ì‹¤íŒ¨');
    }

    const billingData = await tossResponse.json();
    const billingKey = billingData.billingKey;

    // 2. Supabase DBì— ì €ì¥
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? ''
    );

    const userId = req.headers.get('user-id'); // ì¸ì¦ í—¤ë”ì—ì„œ ì¶”ì¶œ
    const productId = tier === 'premium'
      ? 'premium-product-uuid'
      : 'pro-product-uuid';

    const now = new Date();
    const nextBillingDate = new Date(now);
    nextBillingDate.setMonth(nextBillingDate.getMonth() + 1);

    const { data: subscription, error } = await supabase
      .from('subscriptions')
      .insert({
        user_id: userId,
        product_id: productId,
        billing_key: billingKey,
        customer_key: customerKey,
        status: 'ACTIVE',
        tier: tier,
        started_at: now.toISOString(),
        current_period_start: now.toISOString(),
        current_period_end: nextBillingDate.toISOString(),
        next_billing_date: nextBillingDate.toISOString(),
        amount: tier === 'premium' ? 9900 : 19900,
        billing_cycle: 'monthly',
      })
      .select()
      .single();

    if (error) throw error;

    // 3. users í…Œì´ë¸” ì—…ë°ì´íŠ¸
    await supabase
      .from('users')
      .update({
        subscription_tier: tier,
        subscription_status: 'active',
        billing_key: billingKey,
        subscription_started_at: now.toISOString(),
        subscription_expires_at: nextBillingDate.toISOString(),
      })
      .eq('id', userId);

    return new Response(
      JSON.stringify({ success: true, subscription }),
      { headers: { 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 400, headers: { 'Content-Type': 'application/json' } }
    );
  }
});
```

### Edge Function: ì •ê¸° ê²°ì œ ìë™ ì²­êµ¬

```typescript
// supabase/functions/process-billing/index.ts

import { serve } from 'https://deno.land/std@0.168.0/http/server.ts';
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

serve(async (req) => {
  try {
    const supabase = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? '' // Service Role Key ì‚¬ìš©
    );

    // 1. ì˜¤ëŠ˜ ê²°ì œí•´ì•¼ í•  êµ¬ë… ì¡°íšŒ
    const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

    const { data: subscriptions, error: fetchError } = await supabase
      .from('subscriptions')
      .select('*')
      .eq('status', 'ACTIVE')
      .lte('next_billing_date', today);

    if (fetchError) throw fetchError;

    const results = [];

    // 2. ê° êµ¬ë…ë§ˆë‹¤ ìë™ ê²°ì œ ì²˜ë¦¬
    for (const subscription of subscriptions) {
      try {
        // 2-1. ë¹Œë§í‚¤ë¡œ ê²°ì œ ìš”ì²­
        const orderId = `subscription_${subscription.id}_${Date.now()}`;

        const tossResponse = await fetch(
          'https://api.tosspayments.com/v1/billing/' + subscription.billing_key,
          {
            method: 'POST',
            headers: {
              'Authorization': `Basic ${btoa(Deno.env.get('TOSS_SECRET_KEY') + ':')}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              customerKey: subscription.customer_key,
              amount: subscription.amount,
              orderId: orderId,
              orderName: `${subscription.tier} êµ¬ë… - ${today}`,
            }),
          }
        );

        const paymentData = await tossResponse.json();

        if (!tossResponse.ok) {
          throw new Error(paymentData.message || 'ê²°ì œ ì‹¤íŒ¨');
        }

        // 2-2. ê²°ì œ ì„±ê³µ ì‹œ DB ì—…ë°ì´íŠ¸
        // payments í…Œì´ë¸”ì— ì €ì¥
        const { data: payment } = await supabase
          .from('payments')
          .insert({
            user_id: subscription.user_id,
            product_id: subscription.product_id,
            payment_key: paymentData.paymentKey,
            order_id: orderId,
            order_name: `${subscription.tier} êµ¬ë…`,
            amount: subscription.amount,
            payment_method: paymentData.method,
            payment_status: 'DONE',
            approved_at: new Date().toISOString(),
            receipt_url: paymentData.receiptUrl,
          })
          .select()
          .single();

        // subscription_payments ê¸°ë¡
        await supabase
          .from('subscription_payments')
          .insert({
            subscription_id: subscription.id,
            payment_id: payment.id,
            billing_date: today,
            amount: subscription.amount,
            status: 'SUCCESS',
          });

        // ë‹¤ìŒ ê²°ì œì¼ ê°±ì‹  (+1ê°œì›”)
        const nextBillingDate = new Date(subscription.next_billing_date);
        nextBillingDate.setMonth(nextBillingDate.getMonth() + 1);

        await supabase
          .from('subscriptions')
          .update({
            current_period_start: subscription.current_period_end,
            current_period_end: nextBillingDate.toISOString(),
            next_billing_date: nextBillingDate.toISOString(),
          })
          .eq('id', subscription.id);

        results.push({
          subscription_id: subscription.id,
          status: 'success'
        });

      } catch (error) {
        // 2-3. ê²°ì œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬
        console.error(`êµ¬ë… ${subscription.id} ê²°ì œ ì‹¤íŒ¨:`, error);

        // subscription_payments ì‹¤íŒ¨ ê¸°ë¡
        await supabase
          .from('subscription_payments')
          .insert({
            subscription_id: subscription.id,
            billing_date: today,
            amount: subscription.amount,
            status: 'FAILED',
          });

        // ì¬ì‹œë„ ë¡œì§ (3íšŒ ì‹¤íŒ¨ ì‹œ PAUSED)
        // TODO: ì¬ì‹œë„ ì¹´ìš´í„° êµ¬í˜„

        results.push({
          subscription_id: subscription.id,
          status: 'failed',
          error: error.message
        });
      }
    }

    return new Response(
      JSON.stringify({
        processed: subscriptions.length,
        results
      }),
      { headers: { 'Content-Type': 'application/json' } }
    );

  } catch (error) {
    return new Response(
      JSON.stringify({ error: error.message }),
      { status: 500, headers: { 'Content-Type': 'application/json' } }
    );
  }
});
```

---

## ë³´ì•ˆ ì„¤ê³„

### 1. ì‹œí¬ë¦¿ í‚¤ ê´€ë¦¬

**ì ˆëŒ€ ê·œì¹™**:
- âŒ **Flutter ì•±ì— ì‹œí¬ë¦¿ í‚¤ í¬í•¨ ê¸ˆì§€**
- âŒ **Git ì»¤ë°‹ ê¸ˆì§€**
- âœ… **Supabase Edge Functions í™˜ê²½ ë³€ìˆ˜ë¡œë§Œ ì‚¬ìš©**

```bash
# Supabase ëŒ€ì‹œë³´ë“œì—ì„œ ì„¤ì •
# Settings > Edge Functions > Environment variables

TOSS_CLIENT_KEY=test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm  # ê³µê°œ ê°€ëŠ¥
TOSS_SECRET_KEY=test_sk_D5GePWvyJnrK0W0k6q8gLzN97Eoq  # ì ˆëŒ€ ë¹„ê³µê°œ
```

### 2. ê¸ˆì•¡ ê²€ì¦ (Amount Validation)

**ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ ë°©ì§€**:
- í´ë¼ì´ì–¸íŠ¸ì—ì„œ ê¸ˆì•¡ ì¡°ì‘ ì‹œë„ ì°¨ë‹¨
- DBì— ì„ì‹œ ì €ì¥ëœ ê¸ˆì•¡ê³¼ ë°˜í™˜ëœ ê¸ˆì•¡ ë¹„êµ

```typescript
// Edge Function: confirm-payment
async function validatePaymentAmount(orderId: string, amount: number): Promise<boolean> {
  const { data } = await supabase
    .from('payments')
    .select('amount')
    .eq('order_id', orderId)
    .single();

  if (!data || data.amount !== amount) {
    throw new Error('ê²°ì œ ê¸ˆì•¡ ë¶ˆì¼ì¹˜: ì¡°ì‘ ì˜ì‹¬');
  }

  return true;
}
```

### 3. ë©±ë“±ì„± ë³´ì¥ (Idempotency)

**ì¤‘ë³µ ê²°ì œ ë°©ì§€**:

```typescript
// Edge Functionì—ì„œ ë©±ë“±ì„± ì²´í¬
async function checkIdempotency(paymentKey: string): Promise<boolean> {
  const { data } = await supabase
    .from('payments')
    .select('payment_status')
    .eq('payment_key', paymentKey)
    .single();

  if (data && data.payment_status === 'DONE') {
    // ì´ë¯¸ ìŠ¹ì¸ëœ ê²°ì œ
    return false; // ì¤‘ë³µ ì²˜ë¦¬ ì°¨ë‹¨
  }

  return true; // ì²˜ë¦¬ ê°€ëŠ¥
}
```

### 4. Row Level Security (RLS)

**ë°ì´í„° ì ‘ê·¼ ì œì–´**:

```sql
-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ê²°ì œ ì •ë³´ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Users can view own payments"
  ON payments FOR SELECT
  USING (auth.uid() = user_id);

-- ê´€ë¦¬ìëŠ” ëª¨ë“  ê²°ì œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Admins can view all payments"
  ON payments FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM user_roles
      WHERE user_id = auth.uid() AND role = 'admin'
    )
  );
```

### 5. ì›¹í›… ì„œëª… ê²€ì¦

**ì›¹í›… ìœ„ì¡° ë°©ì§€**:

```typescript
// í† ìŠ¤í˜ì´ë¨¼ì¸  ì›¹í›… ì„œëª… ê²€ì¦
import { createHmac } from 'https://deno.land/std@0.168.0/node/crypto.ts';

function verifyWebhookSignature(
  payload: string,
  signature: string,
  secret: string
): boolean {
  const computedSignature = createHmac('sha256', secret)
    .update(payload)
    .digest('hex');

  return computedSignature === signature;
}
```

---

## êµ¬í˜„ ê°€ì´ë“œ

### 1. Flutter íŒ¨í‚¤ì§€ ì„¤ì¹˜

```yaml
# pubspec.yaml
dependencies:
  # í† ìŠ¤í˜ì´ë¨¼ì¸  ìœ„ì ¯ SDK
  tosspayments_widget_sdk_flutter: ^2.1.2

  # Supabase
  supabase_flutter: ^2.8.3

  # ìƒíƒœ ê´€ë¦¬
  flutter_bloc: ^9.1.1

  # ì˜ì¡´ì„± ì£¼ì…
  get_it: ^8.0.3
```

### 2. Android ì„¤ì •

```xml
<!-- android/app/src/main/AndroidManifest.xml -->
<manifest>
  <application
    android:usesCleartextTraffic="true">
    <!-- AppCard ì•± ì‹¤í–‰ì„ ìœ„í•œ ì„¤ì • -->
  </application>

  <uses-permission android:name="android.permission.INTERNET" />
</manifest>
```

```gradle
// android/app/build.gradle
android {
  defaultConfig {
    minSdkVersion 19  // ìµœì†Œ ìš”êµ¬ì‚¬í•­
  }
}
```

### 3. iOS ì„¤ì •

```xml
<!-- ios/Runner/Info.plist -->
<dict>
  <key>NSAppTransportSecurity</key>
  <dict>
    <key>NSAllowsArbitraryLoads</key>
    <true/>
  </dict>

  <!-- ì¹´ë“œì‚¬ ì•± URL Scheme -->
  <key>LSApplicationQueriesSchemes</key>
  <array>
    <string>hdcardappcardansimclick</string>
    <string>smhyundaiansimclick</string>
    <!-- ê¸°íƒ€ ì¹´ë“œì‚¬ ì•±... -->
  </array>
</dict>
```

### 4. Flutter ê²°ì œ ìœ„ì ¯ êµ¬í˜„

```dart
// presentation/widgets/toss_payment_widget.dart

import 'package:flutter/material.dart';
import 'package:tosspayments_widget_sdk_flutter/tosspayments_widget_sdk_flutter.dart';

class TossPaymentWidget extends StatefulWidget {
  final int amount;
  final String orderName;
  final String customerKey;
  final Function(PaymentResult) onSuccess;
  final Function(PaymentResult) onFail;

  const TossPaymentWidget({
    Key? key,
    required this.amount,
    required this.orderName,
    required this.customerKey,
    required this.onSuccess,
    required this.onFail,
  }) : super(key: key);

  @override
  State<TossPaymentWidget> createState() => _TossPaymentWidgetState();
}

class _TossPaymentWidgetState extends State<TossPaymentWidget> {
  late PaymentWidget _paymentWidget;
  PaymentMethodWidgetControl? _paymentMethodWidgetControl;
  AgreementWidgetControl? _agreementWidgetControl;

  @override
  void initState() {
    super.initState();
    _initializePaymentWidget();
  }

  void _initializePaymentWidget() {
    _paymentWidget = PaymentWidget(
      clientKey: 'test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm', // í´ë¼ì´ì–¸íŠ¸ í‚¤
      customerKey: widget.customerKey,
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('ê²°ì œí•˜ê¸°')),
      body: Column(
        children: [
          // ê²°ì œ ê¸ˆì•¡ í‘œì‹œ
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Text(
              'ê²°ì œ ê¸ˆì•¡: ${widget.amount.toStringAsFixed(0)}ì›',
              style: const TextStyle(fontSize: 20, fontWeight: FontWeight.bold),
            ),
          ),

          // ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ UI
          Expanded(
            child: PaymentMethodWidget(
              paymentWidget: _paymentWidget,
              selector: 'payment-method', // HTML selector ID
              amount: Amount(
                value: widget.amount,
                currency: 'KRW',
                country: 'KR',
              ),
              onLoadEnd: (control) {
                setState(() {
                  _paymentMethodWidgetControl = control;
                });
              },
            ),
          ),

          // ì•½ê´€ ë™ì˜ UI
          AgreementWidget(
            paymentWidget: _paymentWidget,
            selector: 'agreement',
            onLoadEnd: (control) {
              setState(() {
                _agreementWidgetControl = control;
              });
            },
          ),

          // ê²°ì œí•˜ê¸° ë²„íŠ¼
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: ElevatedButton(
              onPressed: _requestPayment,
              style: ElevatedButton.styleFrom(
                minimumSize: const Size.fromHeight(50),
              ),
              child: const Text('ê²°ì œí•˜ê¸°'),
            ),
          ),
        ],
      ),
    );
  }

  Future<void> _requestPayment() async {
    // ì•½ê´€ ë™ì˜ í™•ì¸
    final agreementStatus = await _agreementWidgetControl?.getAgreementStatus();
    if (agreementStatus != null && !agreementStatus) {
      _showDialog('í•„ìˆ˜ ì•½ê´€ì— ë™ì˜í•´ì£¼ì„¸ìš”.');
      return;
    }

    // ê²°ì œ ìš”ì²­
    final orderId = 'order_${DateTime.now().millisecondsSinceEpoch}';

    final result = await _paymentWidget.requestPayment(
      paymentInfo: PaymentInfo(
        orderId: orderId,
        orderName: widget.orderName,
      ),
    );

    if (result.success != null) {
      widget.onSuccess(result);
    } else if (result.fail != null) {
      widget.onFail(result);
    }
  }

  void _showDialog(String message) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        content: Text(message),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('í™•ì¸'),
          ),
        ],
      ),
    );
  }
}
```

### 5. ê²°ì œ BLoC êµ¬í˜„

```dart
// presentation/bloc/payment_bloc.dart

import 'package:flutter_bloc/flutter_bloc.dart';
import 'package:equatable/equatable.dart';
import 'package:tosspayments_widget_sdk_flutter/model/payment_result.dart';

// Events
abstract class PaymentEvent extends Equatable {
  @override
  List<Object?> get props => [];
}

class PaymentRequested extends PaymentEvent {
  final PaymentResult result;
  PaymentRequested(this.result);

  @override
  List<Object?> get props => [result];
}

class SubscribeRequested extends PaymentEvent {
  final String tier;
  final int subscriptionPrice;

  SubscribeRequested({
    required this.tier,
    required this.subscriptionPrice,
  });

  @override
  List<Object?> get props => [tier, subscriptionPrice];
}

// States
abstract class PaymentState extends Equatable {
  @override
  List<Object?> get props => [];
}

class PaymentInitial extends PaymentState {}
class PaymentLoading extends PaymentState {}
class PaymentSuccess extends PaymentState {
  final String receiptUrl;
  PaymentSuccess(this.receiptUrl);

  @override
  List<Object?> get props => [receiptUrl];
}
class PaymentFailure extends PaymentState {
  final String message;
  PaymentFailure(this.message);

  @override
  List<Object?> get props => [message];
}

// BLoC
class PaymentBloc extends Bloc<PaymentEvent, PaymentState> {
  final ConfirmPaymentUseCase confirmPaymentUseCase;
  final CreateSubscriptionUseCase createSubscriptionUseCase;

  PaymentBloc({
    required this.confirmPaymentUseCase,
    required this.createSubscriptionUseCase,
  }) : super(PaymentInitial()) {
    on<PaymentRequested>(_onPaymentRequested);
    on<SubscribeRequested>(_onSubscribeRequested);
  }

  Future<void> _onPaymentRequested(
    PaymentRequested event,
    Emitter<PaymentState> emit,
  ) async {
    emit(PaymentLoading());

    try {
      final result = event.result;
      if (result.success == null) {
        throw Exception(result.fail?.message ?? 'ê²°ì œ ì‹¤íŒ¨');
      }

      // Edge Functionìœ¼ë¡œ ê²°ì œ ìŠ¹ì¸ ìš”ì²­
      final payment = await confirmPaymentUseCase(
        ConfirmPaymentParams(
          paymentKey: result.success!.paymentKey,
          orderId: result.success!.orderId,
          amount: result.success!.amount,
        ),
      );

      emit(PaymentSuccess(payment.receiptUrl));
    } catch (e) {
      emit(PaymentFailure(e.toString()));
    }
  }

  Future<void> _onSubscribeRequested(
    SubscribeRequested event,
    Emitter<PaymentState> emit,
  ) async {
    // êµ¬ë… ë¡œì§ (ì•ì„œ êµ¬í˜„í•œ ì½”ë“œ ì°¸ì¡°)
    // ...
  }
}
```

---

## í…ŒìŠ¤íŠ¸ ê³„íš

### 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (Unit Tests)

```dart
// test/features/payment/domain/usecases/confirm_payment_test.dart

void main() {
  group('ConfirmPayment UseCase', () {
    test('should confirm payment with valid params', () async {
      // Arrange
      final mockRepo = MockPaymentRepository();
      final useCase = ConfirmPayment(mockRepo);

      when(() => mockRepo.confirmPayment(any()))
          .thenAnswer((_) async => Right(tPayment));

      // Act
      final result = await useCase(tParams);

      // Assert
      expect(result, Right(tPayment));
      verify(() => mockRepo.confirmPayment(tParams));
    });
  });
}
```

### 2. í†µí•© í…ŒìŠ¤íŠ¸ (Integration Tests)

```dart
// integration_test/payment_flow_test.dart

void main() {
  group('Payment Flow Integration Test', () {
    testWidgets('should complete payment successfully', (tester) async {
      await tester.pumpWidget(MyApp());

      // 1. ìƒí’ˆ ì„ íƒ
      await tester.tap(find.text('AI ìƒë‹´ êµ¬ë§¤'));
      await tester.pumpAndSettle();

      // 2. ê²°ì œí•˜ê¸° ë²„íŠ¼ í´ë¦­
      await tester.tap(find.text('ê²°ì œí•˜ê¸°'));
      await tester.pumpAndSettle();

      // 3. ê²°ì œ ìˆ˜ë‹¨ ì„ íƒ
      // (í† ìŠ¤ ìœ„ì ¯ ë‚´ë¶€ì´ë¯€ë¡œ ìë™í™” ì–´ë ¤ì›€)

      // 4. ê²°ì œ ì™„ë£Œ í™•ì¸
      expect(find.text('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤'), findsOneWidget);
    });
  });
}
```

### 3. í† ìŠ¤í˜ì´ë¨¼ì¸  í…ŒìŠ¤íŠ¸ í™˜ê²½ í™œìš©

**í…ŒìŠ¤íŠ¸ ì¹´ë“œ ì •ë³´**:
```
ì¹´ë“œ ë²ˆí˜¸: 5570-7512-3456-1234 (Mastercard)
ìœ íš¨ ê¸°ê°„: 12/25
CVC: 123
ë¹„ë°€ë²ˆí˜¸: 00
```

**íŠ¹ì • ì—ëŸ¬ ì¬í˜„**:
```bash
# API ìš”ì²­ í—¤ë”ì— ì¶”ê°€
TossPayments-Test-Code: INVALID_CARD_EXPIRATION
```

---

## ê³µì‹ ë¬¸ì„œ ë§í¬

### í† ìŠ¤í˜ì´ë¨¼ì¸ 
- ğŸ“˜ **ê°œë°œì ì„¼í„°**: https://docs.tosspayments.com
- ğŸ“¦ **Flutter SDK**: https://pub.dev/packages/tosspayments_widget_sdk_flutter
- ğŸ”‘ **API ë ˆí¼ëŸ°ìŠ¤**: https://docs.tosspayments.com/reference
- ğŸ’¬ **Discord ì»¤ë®¤ë‹ˆí‹°**: https://discord.gg/tosspayments

### Supabase
- ğŸ“— **Edge Functions**: https://supabase.com/docs/guides/functions
- ğŸ—„ï¸ **PostgreSQL**: https://supabase.com/docs/guides/database
- ğŸ” **Row Level Security**: https://supabase.com/docs/guides/auth/row-level-security

---

## ë‹¤ìŒ ë‹¨ê³„

1. âœ… **ì „ìê²°ì œ ì‹ ì²­ ì™„ë£Œ** (í† ìŠ¤í˜ì´ë¨¼ì¸  ê°€ë§¹ì  ë“±ë¡)
2. â³ **Supabase í”„ë¡œì íŠ¸ ìƒì„± ë° í…Œì´ë¸” ì„¤ì •**
3. â³ **Edge Functions ë°°í¬**
4. â³ **Flutter ê²°ì œ UI êµ¬í˜„**
5. â³ **í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ê²€ì¦**
6. â³ **í”„ë¡œë•ì…˜ ë°°í¬**

---

**ì‘ì„±ì¼**: 2026-01-01
**ì‘ì„±ì**: Claude Code
**ë²„ì „**: 1.0.0
